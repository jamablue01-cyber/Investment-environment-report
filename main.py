import os
import datetime
import requests
from openai import OpenAI

# 1. æ—¥ä»˜ã®è‡ªå‹•è¨ˆç®—

def get_date_range():
today = datetime.datetime.now()
# å‰é€±ã®æœˆæ›œæ—¥ã¨é‡‘æ›œæ—¥ã‚’ç‰¹å®š
last_monday = today - datetime.timedelta(days=today.weekday() + 7)
last_friday = last_monday + datetime.timedelta(days=4)
return last_monday.strftime('%Yå¹´%mæœˆ%dæ—¥'), last_friday.strftime('%mæœˆ%dæ—¥')

monday_str, friday_str = get_date_range()

# 2. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®çµ„ã¿ç«‹ã¦ï¼ˆã”æŒ‡å®šã®å†…å®¹ï¼‰

PROMPT = f"""
ç§ã¯ç±³å›½æ ªæŠ•è³‡å®¶ã§ã€ä¸»è¦æŠ•è³‡å¯¾è±¡ã¯TSLAã€PLTRã€SOFIã€CELHã§ã™ã€‚å‰é€±ï¼ˆ{monday_str}ã‹ã‚‰{friday_str}ï¼‰ã¨ãã®å‰ã€…é€±ã®NYSEã¨NASDAQã®ç›¸å ´çŠ¶æ³ã€é‡‘èç’°å¢ƒã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚ä»¥ä¸‹ã®é …ç›®ã«ã¤ã„ã¦ã€å‰ã€…é€±ã¨ã®æ¯”è¼ƒã‚’äº¤ãˆã€ãƒ‡ãƒ¼ã‚¿ã‚’ç°¡æ½”ã«ã¾ã¨ã‚ã€ç°¡å˜ãªè¦‹è§£ã‚’åŠ ãˆã¦å ±å‘Šã—ã¦ãã ã•ã„ã€‚å„é …ç›®ã®è¦‹è§£ã§ã¯ã€å¸‚å ´ã¸ã®æ½œåœ¨çš„ãªå½±éŸ¿ã‚’1-2æ–‡ã§è¿°ã¹ã¦ãã ã•ã„ã€‚

å¸‚å ´å…¨ä½“ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ãƒˆãƒ¬ãƒ³ãƒ‰:ä¸»è¦æŒ‡æ•°ã®é€±æ¬¡å¤‰åŒ–ï¼ˆS&P 500, DJIA, NASDAQ Composite, Russell 2000ã®ãƒªã‚¿ãƒ¼ãƒ³ç‡ã¨çµ‚å€¤å¤‰å‹•ï¼‰ã€‚
ã‚»ã‚¯ã‚¿ãƒ¼åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼ˆä¸»è¦ã‚»ã‚¯ã‚¿ãƒ¼ã®é€±æ¬¡ãƒªã‚¿ãƒ¼ãƒ³ï¼‰ã€‚
å¸‚å ´ãƒœãƒªãƒ¥ãƒ¼ãƒ ï¼ˆå–å¼•é‡ã®å¤‰åŒ–ï¼‰ã€‚
ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™ã¨å¸‚å ´ã®å¥åº·åº¦:ãƒ’ãƒ³ãƒ‡ãƒ³ãƒ–ãƒ«ã‚°ã‚ªãƒ¼ãƒ¡ãƒ³ã®å‡ºç¾çŠ¶æ³ã€‚
ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ã‚¤ã®ç™ºç”Ÿæ•°ã€‚
ãƒ•ã‚©ãƒ­ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ‡ã‚¤ã®ç™ºç”ŸçŠ¶æ³ã€‚
å¸‚å ´ã®åºƒã•ï¼ˆæ–°é«˜å€¤/æ–°å®‰å€¤ã®æ•°ã€Advance-Decline Lineï¼‰ã€‚
ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£æŒ‡æ•°ï¼ˆVIXã®å¹³å‡å€¤ã¨å¤‰åŒ–ï¼‰ã€‚
é‡‘èæ”¿ç­–ã¨ãƒã‚¯ãƒ­ç’°å¢ƒ:FRBé‡‘èæ”¿ç­–äºˆæƒ³ï¼ˆåˆ©ä¸Šã’/åˆ©ä¸‹ã’ç¢ºç‡ã€ãƒ‰ãƒƒãƒˆãƒ—ãƒ­ãƒƒãƒˆï¼‰ã€‚
å›½å‚µåˆ©å›ã‚Šï¼ˆ10å¹´ç‰©ç±³å›½å‚µã®å¤‰åŒ–ï¼‰ã€‚
é€šè²¨å‹•å‘ï¼ˆç±³ãƒ‰ãƒ«æŒ‡æ•°DXYã®å¤‰åŒ–ï¼‰ã€‚
å•†å“ä¾¡æ ¼ï¼ˆåŸæ²¹ã€é‡‘ã€éŠ…ã®å¤‰å‹•ï¼‰ã€‚
çµŒæ¸ˆæŒ‡æ¨™ã¨ã‚¤ãƒ™ãƒ³ãƒˆ:é‡è¦çµŒæ¸ˆæŒ‡æ¨™ã®ãƒªãƒªãƒ¼ã‚¹ã¨å¤‰åŒ–ï¼ˆNFP, CPI, PPI, å°å£²å£²ä¸Šé«˜ãªã©ã€äºˆæƒ³ vs å®Ÿéš›å€¤ï¼‰ã€‚
ä¼æ¥­æ±ºç®—ï¼ˆä¸»è¦ä¼æ¥­ã®ç™ºè¡¨ã¨ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ï¼‰ã€‚
åœ°æ”¿å­¦çš„ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ã‚¯ï¼ˆé–¢é€£ãƒ‹ãƒ¥ãƒ¼ã‚¹ï¼‰ã€‚
ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆã¨å¿ƒç†æŒ‡æ¨™:æŠ•è³‡å®¶ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆèª¿æŸ»ï¼ˆAAIIã‚„Fear & Greed Indexï¼‰ã€‚
ãƒ—ãƒƒãƒˆ/ã‚³ãƒ¼ãƒ«æ¯”ç‡ã€‚
ã‚·ãƒ§ãƒ¼ãƒˆã‚¤ãƒ³ã‚¿ãƒ¬ã‚¹ãƒˆï¼ˆä¸»è¦æ ªã®ç©ºå£²ã‚Šæ¯”ç‡ï¼‰ã€‚
ä¸»è¦æŠ•è³‡å¯¾è±¡éŠ˜æŸ„ï¼ˆTSLA, PLTR, SOFI, CELHï¼‰ã®é€±æ¬¡ã¾ã¨ã‚:å„éŠ˜æŸ„ã®æ ªä¾¡é€±æ¬¡å¤‰åŒ–ï¼ˆçµ‚å€¤å¤‰å‹•ç‡ã€å‰é€±æ¯”ï¼‰ã€‚
é–¢é€£ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ±ºç®—ç™ºè¡¨ã€è£½å“/å¥‘ç´„ç™ºè¡¨ã€è¦åˆ¶ãƒ»åœ°æ”¿å­¦å½±éŸ¿ã€ã‚¢ãƒŠãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰/ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ãªã©ï¼‰ã€‚
ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ´»å‹•ã‚„ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ã®æ³¨ç›®ç‚¹ï¼ˆã‚‚ã—é¡•è‘—ãªã‚‰ï¼‰ã€‚
å‰ã€…é€±æ¯”ã®å‹¢ã„å¤‰åŒ–ã¨ç°¡å˜ãªè¦‹è§£ï¼ˆå„éŠ˜æŸ„ã”ã¨ã«1-2æ–‡ã§ã€ãƒã‚¸ãƒ†ã‚£ãƒ–/ãƒã‚¬ãƒ†ã‚£ãƒ–è¦å› ã¨æŠ•è³‡ã¸ã®ç¤ºå”†ï¼‰ã€‚
å…¨ä½“ã®è¦‹è§£ã¨ã—ã¦ã€é€±ã®å¸‚å ´ãƒˆãƒ¬ãƒ³ãƒ‰ã®ã¾ã¨ã‚ã¨ã€ç‰¹ã«TSLA/PLTR/SOFI/CELHã¸ã®æŠ•è³‡æˆ¦ç•¥ã¸ã®ç¤ºå”†ã‚’1æ®µè½ã§è¿°ã¹ã¦ãã ã•ã„ã€‚ãƒ‡ãƒ¼ã‚¿ã¯ä¿¡é ¼ã§ãã‚‹ã‚½ãƒ¼ã‚¹ï¼ˆYahoo Finance, Bloomberg, CNBC, Investing.comãªã©ï¼‰ã‹ã‚‰å–å¾—ã—ã€å¿…è¦ã«å¿œã˜ã¦ã‚¦ã‚§ãƒ–æ¤œç´¢ã‚„ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚ãƒ‹ãƒ¥ãƒ¼ã‚¹ã¯å‰é€±ä¸­å¿ƒã«æœ€æ–°ã®ã‚‚ã®ã‚’å„ªå…ˆã€‚
"""

# 3. Grok APIå®Ÿè¡Œ

def get_grok_report():
client = OpenAI(
api_key=os.environ.get("XAI_API_KEY"),
base_url="https://api.x.ai/v1",
)

```
# ãƒ¢ãƒ‡ãƒ«åã¯æœ€æ–°ã®ã‚‚ã®ã‚’æŒ‡å®š
response = client.chat.completions.create(
    model="grok-2-1212",
    messages=[{"role": "user", "content": PROMPT}]
)
return response.choices[0].message.content

```

# 4. Discordé€ä¿¡

def send_discord(content):
webhook_url = os.environ.get("DISCORD_WEB_HOOK")

```
# Discordã®2000æ–‡å­—åˆ¶é™å¯¾ç­–ï¼ˆè¶…ãˆã‚‹å ´åˆã¯ã‚«ãƒƒãƒˆï¼‰
if len(content) > 1900:
    content = content[:1900] + "\\n...(é•·æ–‡ã®ãŸã‚Discordåˆ¶é™ã«ã‚ˆã‚Šçœç•¥)"

data = {
    "content": f"ğŸš€ **é€±é–“ç±³å›½æ ªãƒ¬ãƒãƒ¼ãƒˆ ({monday_str}ã€œ)**\\n\\n{content}"
}
requests.post(webhook_url, json=data)

```

if **name** == "**main**":
try:
report = get_grok_report()
send_discord(report)
print("Successfully sent to Discord!")
except Exception as e:
print(f"Error: {e}")
